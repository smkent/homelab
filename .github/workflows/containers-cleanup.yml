name: Container cleanup

env:
  IMAGE_PREFIX: homelab

on:
  pull_request:
    types:
    - closed
  delete:
    branches:
    - '*'

jobs:
  cleanup:
    name: Remove obsolete images
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ’¾ Check out repository
      uses: actions/checkout@v4

    - name: ðŸ”‘ Log in to the container registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ§¹ Remove obsolete image tags
      run: |
        if [ "${GITHUB_EVENT_NAME}" = "delete" ] && [ "${GITHUB_REF_TYPE}" = "branch" ]; then
          delete_tag="$(basename "${{ github.event.ref }}")"
        elif [ "${GITHUB_EVENT_NAME}" = "pull_request" ] && [ "${GITHUB_EVENT_ACTION}" = "closed" ]; then
          delete_tag="pr-${{ github.event.pull_request.number }}"
        fi
        [ -z "${delete_tag}" ] && { echo "Error detecting deletion label" && exit 1; }
        git ls-files | grep "^compose/images/.*/Dockerfile$" | sort -u | xargs -n1 dirname | xargs -n1 basename | while read -r image_name; do
          image_path="ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_PREFIX }}/${image_name}:${delete_tag}"
          if ! docker manifest inspect "${image_path}" >/dev/null 2>&1; then
            continue
          fi
          echo "Removing image ${image_path}"
          docker rmi "${image_path}" || true
        done
